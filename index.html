<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­é—®ç­”è¯­éŸ³è¯†åˆ« Demo</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    #question { font-weight: bold; margin-top: 20px; display: none; }
    #result { margin-top: 20px; font-size: 1.2em; }
    #answerDetail { margin-top: 10px; font-size: 1em; color: #333; }
    #tip { color: #555; margin-top: 10px; }
</style>
</head>
<body>

<h2>è‹±è¯­é—®ç­”è¯­éŸ³è¯†åˆ« Demo</h2>
<button id="newQuestionBtn">éšæœºå‡ºé¢˜å¹¶æœ—è¯»</button>
<button id="toggleQuestionBtn">æ˜¾ç¤ºé¢˜ç›®</button>
<button id="startBtn">ğŸ¤ å¼€å§‹å½•éŸ³å›ç­”</button>
<button id="stopBtn">â¹ åœæ­¢å½•éŸ³</button>

<div id="tip">æç¤ºï¼š5 ç§’ä¸è¯´è¯å°†è‡ªåŠ¨åœæ­¢å½•éŸ³ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰ã€‚</div>

<div id="question"></div>
<div id="recognizedText"></div>
<div id="result"></div>
<div id="answerDetail"></div>

<script>
let qaList = [];
let currentQA = null;
let recognition = null;
let lastSpeechTime = null;
let silenceTimer = null;
let finalTranscript = "";
let questionVisible = false; // é¢˜ç›®æ˜¾ç¤ºçŠ¶æ€

// ===== ä»å¤–éƒ¨ JSON åŠ è½½é¢˜åº“ =====
fetch('qa.json')
    .then(response => {
        if (!response.ok) throw new Error('åŠ è½½é¢˜åº“å¤±è´¥');
        return response.json();
    })
    .then(data => {
        qaList = data;
        console.log("é¢˜åº“åŠ è½½æˆåŠŸï¼Œå…±", qaList.length, "é“é¢˜");
    })
    .catch(err => {
        console.error(err);
        alert("æ— æ³•åŠ è½½é¢˜åº“ï¼Œè¯·æ£€æŸ¥ qa.json æ˜¯å¦å­˜åœ¨");
    });

// ===== éšæœºå‡ºé¢˜å¹¶æœ—è¯» =====
document.getElementById('newQuestionBtn').addEventListener('click', () => {
    if (qaList.length === 0) {
        alert('é¢˜åº“æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
        return;
    }
    const randomIndex = Math.floor(Math.random() * qaList.length);
    currentQA = qaList[randomIndex];
    // é»˜è®¤éšè—é¢˜ç›®
    questionVisible = false;
    document.getElementById('question').style.display = 'none';
    document.getElementById('question').textContent = currentQA.q;
    document.getElementById('toggleQuestionBtn').textContent = "æ˜¾ç¤ºé¢˜ç›®";
    document.getElementById('recognizedText').textContent = '';
    document.getElementById('result').textContent = '';
    document.getElementById('answerDetail').textContent = '';
    finalTranscript = "";

    // è‡ªåŠ¨æœ—è¯»é¢˜ç›®
    readText(currentQA.q);
});

// ===== æ˜¾ç¤º/éšè—é¢˜ç›® =====
document.getElementById('toggleQuestionBtn').addEventListener('click', () => {
    if (!currentQA) {
        alert('è¯·å…ˆç‚¹å‡»â€œéšæœºå‡ºé¢˜å¹¶æœ—è¯»â€ï¼');
        return;
    }
    questionVisible = !questionVisible;
    document.getElementById('question').style.display = questionVisible ? 'block' : 'none';
    document.getElementById('toggleQuestionBtn').textContent = questionVisible ? "éšè—é¢˜ç›®" : "æ˜¾ç¤ºé¢˜ç›®";
});

// ===== æœ—è¯»å‡½æ•° =====
function readText(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 1;
    utterance.pitch = 1;
    speechSynthesis.speak(utterance);
}

// ===== è¯­éŸ³è¯†åˆ«åˆå§‹åŒ– =====
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Web Speech APIï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æ‰“å¼€ã€‚');
} else {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.continuous = true;

    recognition.onstart = () => {
        document.getElementById('recognizedText').textContent = 'ğŸ¤ æ­£åœ¨è†å¬...';
        lastSpeechTime = Date.now();
        finalTranscript = "";
        startSilenceTimer();
    };

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        if (transcript) {
            finalTranscript = transcript;
            lastSpeechTime = Date.now();
        }
    };

    recognition.onerror = (event) => {
        document.getElementById('recognizedText').textContent = 'è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error;
        stopSilenceTimer();
    };

    recognition.onend = () => {
        console.log("å½•éŸ³ç»“æŸ");
        stopSilenceTimer();
    };
}

// ===== å¼€å§‹å½•éŸ³ =====
document.getElementById('startBtn').addEventListener('click', () => {
    if (!currentQA) {
        alert('è¯·å…ˆç‚¹å‡»â€œéšæœºå‡ºé¢˜å¹¶æœ—è¯»â€ï¼');
        return;
    }
    recognition.start();
});

// ===== åœæ­¢å½•éŸ³ï¼ˆæ‰‹åŠ¨ï¼‰ =====
document.getElementById('stopBtn').addEventListener('click', () => {
    stopRecognition("â¹ æ‰‹åŠ¨åœæ­¢å½•éŸ³");
});

// ===== è‡ªåŠ¨åœæ­¢å½•éŸ³çš„å®šæ—¶å™¨ =====
function startSilenceTimer() {
    stopSilenceTimer();
    silenceTimer = setInterval(() => {
        if (lastSpeechTime && Date.now() - lastSpeechTime > 5000) {
            stopRecognition("â¹ 5 ç§’æ— è®²è¯ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³");
        }
    }, 1000);
}

function stopSilenceTimer() {
    if (silenceTimer) {
        clearInterval(silenceTimer);
        silenceTimer = null;
    }
}

function stopRecognition(reason) {
    if (recognition) {
        recognition.stop();
    }
    stopSilenceTimer();
    if (reason) {
        document.getElementById('recognizedText').textContent = reason;
    }
    showFinalResult();
}

// ===== æ–‡æœ¬é¢„å¤„ç† =====
function normalize(text) {
    return text.trim().toLowerCase().replace(/[^\w\s]/g, '');
}

// ===== Levenshtein è·ç¦»è®¡ç®— =====
function levenshtein(a, b) {
    const m = [];
    let i, j;
    if (!(a && b)) return (b ? b.length : 0) + (a ? a.length : 0);
    for (i = 0; i <= b.length; m[i] = [i++]);
    for (j = 0; j <= a.length; m[0][j] = j++);
    for (i = 1; i <= b.length; i++) {
        for (j = 1; j <= a.length; j++) {
            m[i][j] = b.charAt(i - 1) === a.charAt(j - 1)
                ? m[i - 1][j - 1]
                : Math.min(
                    m[i - 1][j - 1] + 1,
                    Math.min(m[i][j - 1] + 1, m[i - 1][j] + 1)
                );
        }
    }
    return m[b.length][a.length];
}

// ===== æ¨¡ç³ŠåŒ¹é…åˆ¤æ–­ =====
function isAnswerCorrect(userAnswer, correctAnswer) {
    const ua = normalize(userAnswer);
    const ca = normalize(correctAnswer);
    if (!ua || !ca) return false;

    if (ua === ca) return true;
    if (ua.includes(ca)) return true;

    const distance = levenshtein(ua, ca);
    const maxLen = Math.max(ua.length, ca.length);
    const similarity = 1 - distance / maxLen;

    return similarity >= 0.8;
}

// ===== æ˜¾ç¤ºæœ€ç»ˆç»“æœ =====
function showFinalResult() {
    if (!currentQA) return;

    if (!finalTranscript) {
        document.getElementById('result').textContent = 'âŒ æœªæ£€æµ‹åˆ°æœ‰æ•ˆå›ç­”';
        document.getElementById('answerDetail').innerHTML = `
            <strong>ä½ çš„å›ç­”ï¼š</strong>ï¼ˆæ— ï¼‰<br>
            <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${currentQA.a}
        `;
        return;
    }

    const correct = isAnswerCorrect(finalTranscript, currentQA.a);
    document.getElementById('result').textContent = correct ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯';
    document.getElementById('answerDetail').innerHTML = `
        <strong>ä½ çš„å›ç­”ï¼š</strong> ${finalTranscript} <br>
        <strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${currentQA.a}
    `;
}
</script>
</body>
</html>
